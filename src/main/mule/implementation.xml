<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:spring="http://www.mulesoft.org/schema/mule/spring" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/spring http://www.mulesoft.org/schema/mule/spring/current/mule-spring.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	
	<spring:config name="springConfig" files="beans.xml" doc:id="8623553f-16f6-45d9-acef-e23764e05bf8" />
	
	<spring:security-manager>
    		<spring:delegate-security-provider name="memory-provider" delegate-ref="authenticationManager" />
 	</spring:security-manager>
	

	<sub-flow name="Security_Sub_Flow" doc:id="97471792-8d5e-4e47-ab1c-65ae24c6ef7d" >
		<http:basic-security-filter realm="mule" />
		<spring:authorization-filter requiredAuthorities="ROLE_ADMIN" doc:id="64de0fab-6550-4ac3-b91c-543dd61a9a06" />
		<logger level="INFO" doc:name="Logger" doc:id="daf5ab74-462b-491c-8792-b2b2b6f7b20e" message="Basic Authentication Successful" />
		<flow-ref doc:name="Validate Queries" doc:id="b44fa15a-85e2-4c89-881e-ad811b63ef90" name="Validate_Queries_Sub_Flow"/>
	</sub-flow>
	<sub-flow name="Validate_Queries_Sub_Flow" doc:id="807e11e7-34d7-439b-9f88-87df451e88c5">
		<choice doc:name="Choice" doc:id="3d02e061-51d3-4468-ad36-b8021732c1a0" >
			<when expression="#[sizeOf(attributes.queryParams) &lt;= 9 and sizeOf(attributes.queryParams) &gt;= 1]">
				<logger level="INFO" doc:name="Logger" doc:id="a6302b38-5a87-471d-ace3-c1cf13ec318f" message="#[sizeOf(attributes.queryParams) as Number]" />
				<flow-ref doc:name="Variable Storage" doc:id="14d77430-6a5f-4d42-a80d-8eda8d884d43" name="Variable_Storage_Sub_Flow" />
			</when>
			<otherwise>
				<set-payload value='#[{message: "Invalid number of queries"}]' doc:name="Invalid Number of queries" doc:id="14042b55-0aee-426d-bb3d-7bb84081d4e1" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="Variable_Storage_Sub_Flow" doc:id="c3f09d86-be90-495e-ae3c-6d03f4717a1b">
		<set-variable value="#[attributes.queryParams.'search_key' as String]" doc:name="search_key" doc:id="7336c7cc-a732-46b5-9c89-a9cc81e4a0e1" variableName="search_key" />
		<set-variable value="#[upper(attributes.queryParams.'search_value' as String)]" doc:name="search_value" doc:id="55b9ef51-5bf6-4707-b932-422d579546c7" variableName="search_value" />
		<set-variable value="#[attributes.queryParams.'page_number']" doc:name="page_number" doc:id="246065c0-e92c-402c-af10-d350ea1bf8ee" variableName="page_number" />
		<set-variable value="#[attributes.queryParams.'results_number']" doc:name="results_number" doc:id="628bfeae-5dbe-41cb-abde-2c6ba293eef8" variableName="results_number" />
		<set-variable value="#[attributes.queryParams]" doc:name="qParams" doc:id="8f4d0bec-f430-4389-b7ec-18acdd8b7f5f" variableName="qParams"/>
		<set-variable value='#[attributes.queryString default ""]' doc:name="OSkey" doc:id="7f9106fd-d9bc-4ea5-b08e-240d598ce388" variableName="OSkey" />
		<os:contains doc:name="Check Cache for qString" doc:id="877ac36f-47e2-4875-8e6e-5cd5bc73b055" key="qString" objectStore="Object_store" target="contains_qString" />
		<choice doc:name="Choice" doc:id="42b4eca4-05da-4862-83fd-8c1a752fbee8" >
			<when expression="#[vars.contains_qString]" >
				<logger level="INFO" doc:name="Logger" doc:id="576f20ae-dd79-40d1-9746-558a15fca471" />
				<os:retrieve doc:name="Retrieve qString" doc:id="1b12eeed-21d3-46bb-8a9c-cf6e75ab59d5" key="qString" objectStore="Object_store">
					<os:default-value ><![CDATA[payload]]></os:default-value>
				</os:retrieve>
			</when>
			<otherwise>
				<os:store doc:name="Store qString" doc:id="8a50558b-8fbd-49b2-823b-ea3ac49382f0" key="qString" objectStore="Object_store" >
					<os:value ><![CDATA[#[attributes.queryString]]]></os:value>
				</os:store>
			</otherwise>
		</choice>
		<flow-ref doc:name="Check Cache" doc:id="56665380-f468-45d7-84aa-8b0c1b5c1057" name="Check_Cache_Sub_Flow" />
	</sub-flow>
	<sub-flow name="Check_Cache_Sub_Flow" doc:id="4a7d867c-71ba-4308-ae81-7a1640db00d1" >
		<choice doc:name="Choice" doc:id="1e2cc419-e683-43c7-90ef-36340be5af66" >
			<when expression='#[payload startsWith vars.OSkey]' >
				<os:retrieve doc:name="Retrieve" doc:id="d49dd6bc-771d-4841-a0b5-f56c148018f1" key="#[vars.OSkey]" objectStore="Object_store" />
				<flow-ref doc:name="Advanced Filtering" doc:id="19dacb43-e97b-402f-b9d1-f3a5f6dae1c4" name="Advanced_FIltering_Sub_Flow"/>
			</when>
			<otherwise >
				<file:read doc:name="Read Original File" doc:id="51391040-48b9-437f-94c8-e6bc8b42d806" config-ref="File_Config" path="${file.path}" />
				<ee:transform doc:name="Transform Individuals" doc:id="55e8887a-1f77-4055-9cec-3b5d17234c45">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload.IAPDIndividualReport.Indvls.*Indvl map ( indvl , indexOfIndvl ) -> {
	Indvl: {
		Info: {
			"lastNm": indvl.Info.@lastNm default "",
			"firstNm": indvl.Info.@firstNm default "",
			"midNm": indvl.Info.@midNm default "",
			"sufNM": indvl.Info.@sufNm default "",
			"city": indvl.CrntEmps.CrntEmp.@city default "",
			"state": indvl.CrntEmps.CrntEmp.@state default "",
			"postlCd": indvl.CrntEmps.CrntEmp.@postlCd default "",
		},
		OthrNms: {
			OthrNm: indvl.OthrNms.*OthrNm map ( othrNm , indexOfOthrNm ) -> {
				"lastNm": othrNm.@lastNm default "",
				"firstNm": othrNm.@firstNm default "",
				"midNm": othrNm.@midNm default "",
				"sufNm": othrNm.@sufNm default ""
			}
		}
		
	}
}

]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<os:store doc:name="Store individuals in cache" doc:id="4cab0187-c324-474c-8be2-73df9d122b3b" key="#[vars.OSkey]" objectStore="Object_store" />
				<logger level="INFO" doc:name="Logger" doc:id="97b9d8e2-502f-4106-87ef-8dc288392d72" message="#[vars.OSkey]"/>
				<flow-ref doc:name="Filtering" doc:id="4e061efc-08f3-4c71-9f17-f4777d852b8f" name="Filtering_Sub_Flow" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="Filtering_Sub_Flow" doc:id="0a0a0980-9181-481a-a6e0-51d7dc83b464" >
		<ee:transform doc:name="First Filter" doc:id="2ee1b0fd-25fc-4fe2-b513-61560cf6e23a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---

{
	results: (payload filter ($.Indvl.Info[vars.search_key] == vars.search_value)) orderBy (vars.search_key),
	filters:[vars.search_key, vars.search_value]
	
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
	</sub-flow>
	<sub-flow name="Advanced_FIltering_Sub_Flow" doc:id="ade77e81-d21b-417c-949d-ad516598ffa8" >
		<foreach doc:name="For Each" doc:id="3734bddc-c564-4982-83c2-f6a6836f2adb" collection="#[(vars.qParams filterObject((value, key, index)-&gt; index &gt; 1 and index &lt; 8))]">
			<ee:transform doc:name="Copy_of_First Filter" doc:id="d4628de4-b29b-46da-bc0e-cb7a22ab2628" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---

{
	results: (payload filter ($.Indvl.Info[] == vars.search_value)) orderBy (vars.search_key),
	filters:[vars.search_key, vars.search_value]
	
}
]]></ee:set-payload>
				</ee:message>
			</ee:transform>
		</foreach>
	</sub-flow>

</mule>

